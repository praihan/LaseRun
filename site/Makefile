include Makefile.inc
include SOURCES.inc

BUILD_DIR :=build
DEBUG_DIR :=debug
RELEASE_DIR :=release
CP_FILES :=assets
INDEX_FILENAME :=index.html
OUTPUT_FILE_NAME :=build.js
JSC_BASE_DIR :=$(PROJECT_ROOT)/$(TOOLS_JSCOMPILER)

JSC =$(JAVA_JAR) $(JSC_BASE_DIR)/$(TOOLS_JSCOMPILER_FILENAME)

JSC_FLAGS :=--language_in ECMASCRIPT5
JSC_FLAGS_DEBUG :=$(JSC_FLAGS) --formatting PRETTY_PRINT

DEFAULT_BUILD :=debug

all: build

build_dir:
	$(MKDIR) -p $(BUILD_DIR)

release: build_dir
	$(MKDIR) -p $(BUILD_DIR)/$(RELEASE_DIR)
	$(CP) -r -f $(CP_FILES) $(BUILD_DIR)/$(RELEASE_DIR)/
	$(JSC) $(JSC_FLAGS) $(TOOLS_JSCOMPILER_FLAG_INPUT) $(INPUT_FILES) $(TOOLS_JSCOMPILER_FLAG_OUTPUT) $(BUILD_DIR)/$(RELEASE_DIR)/$(OUTPUT_FILE_NAME)
	$(JAVA_JAR) $(PROJECT_ROOT)/$(TOOLS_HTMINJECT)/$(TOOLS_HTMINJECT_FILENAME) $(INDEX_FILENAME) $(BUILD_DIR)/$(RELEASE_DIR)/$(INDEX_FILENAME) $(OUTPUT_FILE_NAME)

debug: build_dir
	$(MKDIR) -p $(BUILD_DIR)/$(DEBUG_DIR)
	$(CP) -r -f $(CP_FILES) $(BUILD_DIR)/$(DEBUG_DIR)/
	$(JSC) $(JSC_FLAGS_DEBUG) $(TOOLS_JSCOMPILER_FLAG_INPUT) $(INPUT_FILES) $(TOOLS_JSCOMPILER_FLAG_OUTPUT) $(BUILD_DIR)/$(DEBUG_DIR)/$(OUTPUT_FILE_NAME)
	$(JAVA_JAR) $(PROJECT_ROOT)/$(TOOLS_HTMINJECT)/$(TOOLS_HTMINJECT_FILENAME) $(INDEX_FILENAME) $(BUILD_DIR)/$(DEBUG_DIR)/$(INDEX_FILENAME) $(OUTPUT_FILE_NAME)

build: $(DEFAULT_BUILD)

clean_release:
	$(RM) -rf $(BUILD_DIR)/$(RELEASE_DIR)

clean_debug:
	$(RM) -rf $(BUILD_DIR)/$(DEBUG_DIR)

clean: 
	$(RM) -rf $(BUILD_DIR)

.PHONY : build_dir build debug all clean clean_build clean_debug